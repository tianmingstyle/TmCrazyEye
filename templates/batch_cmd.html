{% extends 'index.html' %}

 {% block page-content %}
    <div class="container-fluid">
    {% csrf_token %}
      <div class="row">
          <!-- 主机选择部分 -->
         <div class="col-xs-6 col-md-4">
             <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">选择需要操作的主机</h3>
              </div>
              <div class="panel-body">
{#                Panel content#}
                   <p>主机分组</p>
                {% for host_group in group_host_list %}
                    <li onclick="ItemToggle(this)">{{ host_group.name }} <span>{{ host_group.host_to_remote_user.count }}</span></li>
                    <ul>
                         <li>
                            {% for hosts in host_group.host_to_remote_user.all %}
                                   <li><input type="checkbox" tag="host_select" value="{{ hosts.id }}"/>
                                         {{ hosts.remote_user.username }}@{{ hosts.host.ip }}
                                   </li>
                            {% endfor %}
                        </li>
                    </ul>

                {% endfor %}
              <p onclick="ItemToggle(this)">未分组主机</p>
              <ul>
                    {% for hosts in ungroup_host_list %}

                    <li><input type="checkbox" tag="host_select" value="{{ hosts.id }}"/>
                        {{ hosts.remote_user.username }}@{{ hosts.host.ip }}
                    </li>
                {% endfor %}
              </ul>

              </div>
            </div>
         </div>
          <!--命令输入和执行结果部分-->
         <div class="col-xs-6 col-md-8">
            <div class="input-group input-group-lg">
              <span class="input-group-addon" id="sizing-addon1"></span>
              <input type="text" id="cmd" class="form-control" placeholder="请输入要执行的命令" aria-describedby="sizing-addon1">
            </div>
            <!-- Indicates a successful or positive action -->
            <button type="button" class="btn btn-success" onclick="PostData()" style="margin-left: 1000px">执行命令</button>
         </div>
      </div>
    </div>

     <script>

        function ItemToggle(ths){
            //console.log(this);
            //var  _ths = this

            $(ths).next().toggle();
        }

        function PostData(){
            var cmd_text = $('#cmd').val().trim();
            var selected_host_ids = [];
{#            console.log(cmd_text);#}
            $('[tag="host_select"]:checked').each(function(){
                selected_host_ids.push($(this).val());

            })
{#            console.log(selected_host_ids);#}

            //验证cmd&selected_host，都不能为空
            if (!cmd_text){
                alert("命令不能为空!");
                return false;
            }

            if (selected_host_ids.length==0){
                alert("你还没有选择要执行命令的主机!");
                return false;
            }
            //将选择的主机和要执行的命令传到后台
            var task_argus={
                "selected_host":selected_host_ids,
                "task_type": "cmd",
                "cmd":cmd_text
            }
            var csrfmiddlewaretoken=$('input[name="csrfmiddlewaretoken"]').val()
            $.post("{% url "batch_cmd_mgr" %}", {"task_data":JSON.stringify(task_argus),"csrfmiddlewaretoken":csrfmiddlewaretoken}, function(callback){
                console.log("callback:"+callback);
            })
        }
     </script>
 {% endblock %}